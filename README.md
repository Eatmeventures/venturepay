# venuepay (based on Masterpass Reference Implementation)
 
## Merchant Facebook Messenger Chatbot

This reference implementation will show you how to set up a simple Facebook Messenger Chatbot and connect with a 
Masterpass Enabled Merchant to process a payment in-chat.

## What you'll need
* Masterpass FB Chatbot sample source code. https://link.to.source.code
* Facebook Page to host your chatbot. https://www.facebook.com/help/104002523024878?helpref=about_content
* Facebook Developer Account. https://developers.facebook.com/
* Node.js V6+. https://nodejs.org/en/
* Ngrok webhook https://ngrok.com/

## Quick Start - Setting up the sample chatbot
Follow this quick start guide to set up the sample chatbot and try it out for yourself.
The rest of the guide will go deeper on how the connection with Masterpass works.

### 1. Create a Facebook Messenger App and Page.
Create a new Facebook App and Page or use existing ones. Go to the App Dashboard and under Product Settings click "Add Product" and select "Messenger."
https://developers.facebook.com/docs/messenger-platform/quickstart

### 2. Set the FB Page Access Token as an Environment Variable
The sample chatbot will load the require credentials from the environment variables.

```export PAGE_ACCESS_TOKEN="my_fbpage_access_token"```

### 3. Setup a development webhook
Facebook requires a webhook to deliver the messages your chatbot receives. 
We recommend using ngrok to easily set up a development webhook to test your bot. https://ngrok.com/ 
Start Ngrok pointing to 40410 which is the default port of your bot. 
You can replace the listening port of the bot by changing the environment variable PORT.

```export PORT="40410"```

### 4. Start Node.js Chatbot server
Now it's time to start the node.js server, to do this go to your project and do:

```shell
npm install
npm start
```
This will start your server on the listening port specified before.

### 5. Configure the webhook in Facebook Developer Portal
In the Webhooks section, click "Setup Webhooks." 
Use the URL generated by your ngrok server as the webhook URL, check all the subscription fields, 
and enter the Verification Token 'masterpass_chatbot'.

### 6. Test the chatbot
Congratulations! At this stage you should have a working chatbot responding to your messages.
If your chatbot is not responding review the steps in this link https://developers.facebook.com/docs/messenger-platform/quickstart

## Masterpass Merchant Reference Implementation
It's important to note that this sample chatbot leverages the Masterpass Merchant reference implementation to create a complete end-to-end commerce experience.
The chatbot never connect to Masterpass directly.

[Facebook]<---->[Chatbot]<---->[Merchant]<---->[Masterpass]

(Image representing resposabilities of each actor)

For more information about the Masterpass Merchant Reference Implementation go to: 

## Communicating with the Masterpass Merchant Backend

### 0. Get products and add to cart
The Masterpass Merchant provides endpoints to common actions such as retrieving product catalog or managing product carts.
All the Masterpass Merchant API calls are encapsulated in the api-client.js prototype in the Sample Chatbot. 
You can Review this prototype to see the calls implementation in detail or visit the Masterpass Merchant documentation.

### 1. Start the account linking flow
In order to process the payments with Masterpass we have to establish a link between the Facebook user account and the Merchant/Masterpass user account.
This link is stored in the Masterpass Merchant backend.
To start the linking we have to send a login message from the bot.

[Sequence Diagram Masterpass/FB account linking]

To begin this linking flow we have to send a special type of FB message:

```shell
curl -X POST -H "Content-Type: application/json" -d '{
  "recipient":{
    "id":"USER_ID"
  },
  "message": {
    "attachment": {
      "type": "template",
      "payload": {
        "template_type": "generic",
        "elements": [{
          "title": "Welcome to M-Bank",
          "image_url": "http://demo.mastercard.com/masterpass_merchant/login.png",
          "buttons": [{
            "type": "account_link",
            "url": "https://demo.mastercard.com/masterpass_merchant/authorize"
          }]
        }]
      }
    }
  }
}' "https://graph.facebook.com/v2.6/me/messages?access_token=PAGE_ACCESS_TOKEN"    
```

If the account linking finishes with a success the chatbot will receive a callback with a session cookie that we can use for 
future calls.

This session cookie holds the credentials needed to identify the user when talking with the merchant. 

Dev Note: For more information about Facebook Messenger Account Linking visit https://developers.facebook.com/docs/messenger-platform/account-linking.

### 2. Starting a pre-checkout flow with the Masterpass Merchant API
After the account linking is finished we should have a valid session cookie that identifies a user in the merchant backend.

We can use this cookie to begin the pre-checkout with the merchant.

```javascript
ApiClient.prototype.getExpressCheckout = function () {

    var url = config.baseUrl + '/api/express';

    request.defaults({ jar: true });
    var jar = request.jar();
    var session = request.cookie('JSESSIONID=30603A1C7AC64C43981F6BE67B937B65');
    jar.setCookie(session, url);

    var promise = new Promise(function (resolve, reject) {
        request({
            uri: url,
            method: "GET",
            jar: jar
        }, function (error, response, body) {
            if (!error && response.statusCode == 200) {
                console.log(body); // Show the body
                resolve(body);
            }
            else {
                reject(error);
            }
        });
    });

    return promise;
};
```
This call will retrieve the contact information, masked credit card details, and addresses so 
that the user can select which card/address to use for the purchase.

### 3. Creating a Cart in the Masterpass Merchant
Before calling the checkout endpoint we need to create a cart in the Masterpass Merchant backend using the buy endpoint.

```javascript
ApiClient.prototype.buyProduct = function (userId, productId) {
    let promise = new Promise(function (resolve, reject) {

        let callback = function (error, response, body) {
            if (!error && response.statusCode == 200) {
                console.log(body);
                resolve(body);
            }
            else {
                reject(body);
            }
        };

        let url = baseUrl + '/buy';

        request.defaults({ jar: true });
        let sessionToken = sessionStore.userData.get(userId).sessionToken;
        let jar = request.jar();
        let session = request.cookie('JSESSIONID=' + sessionToken);
        jar.setCookie(session, url);

        let xsrfToken = sessionStore.userData.get(userId).xsrfToken;
        let token = request.cookie('XSRF-TOKEN=' + xsrfToken);
        jar.setCookie(token, url);
        let header = { 'X-XSRF-TOKEN': xsrfToken };

        let postData = {
            'productId': productId.toString(),
            'quantity': "1"
        };
        let options = {
            uri: url,
            method: "POST",
            json: postData,
            headers: header,
            jar: jar
        };

        request(options, callback);
    });

    return promise;
};
```

### 4. Doing an Express Checkout
To do an Express Checkout we just need to POST to the express checkout endpoint of the Mastercard Merchant API with the
cart, card, address and the session cookie.

```javascript
ApiClient.prototype.expressCheckout = function (userId, cartId, cardId, addressId) {
    let promise = new Promise(function (resolve, reject) {

        let url = baseUrl + '/api/express/' + cartId;

        //The session cookie stores the link between the Merchant User and the FB User.
        //If no link is found, the merchant will return a 404.
        let sessionToken = sessionStore.userData.get(userId).sessionToken;
        let session = request.cookie('JSESSIONID=' + sessionToken);

        //XSRF basic security to stop cross-site attacks.
        let xsrfToken = sessionStore.userData.get(userId).xsrfToken;
        let token = request.cookie('XSRF-TOKEN=' + xsrfToken);

        request.defaults({ jar: true });
        let jar = request.jar();
        jar.setCookie(session, url);
        jar.setCookie(token, url);
        let header = { "X-XSRF-TOKEN": xsrfToken };

        let postData = {
            'cardId': cardId,
            'shippingAddressId': addressId
        };
        let options = {
            uri: url,
            method: "POST",
            headers: header,
            jar: jar,
            json: postData
        };

        request(options, function (error, response, body) {
            if (!error && response.statusCode == 200) {
                resolve(body);
            }
            else {
                reject(body);
            }
        });
    });

    return promise;
};
```

Developed in Mastercard Labs 
by Alonso Araujo (alonso.araujo@mastercard.com )

All rights reserved
2016 - Mastercard
